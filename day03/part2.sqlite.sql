-- our puzzle input
CREATE TABLE input (value STRING);
INSERT INTO input VALUES (
'...#.....#.......##......#.....
...#..................#........
....##....#.......#............
.........#.......#.......#.....
..#..............#.........#..#
.....#.........#....#....#....#
....##..........#.#.##.........
...#....##...#...#...#.#..#....
...#.......###..........#......
.........#.....#....#...#.#....
.#...###..#..##..#.........###.
#.#...#..........###...#....#..
#....#.#..#..........#.......#.
.#..#........##.#..............
............#..#.#............#
.............#..........#......
...#.......#...............#...
.#...#..#..#............#..#...
....##.##..................#.##
#......#...#..##....#.....#...#
#..#..........##....#...###....
##......#.##.#......#..#......#
....#...#.......##.##...#.#..#.
##.#...#....#...#...#........#.
........#..#.....#....#.......#
.#......#......#..............#
.#.....#..#..#..#..#..#....#..#
.......#.....#.................
.#......#...#..#..#...#...#....
.........#..#..#.........#.....
.....#.........#.#..........#..
#......#....#....##....#.#.#...
................##.#...........
.....##.....#............#.#...
...........#...#.#..##...#.....
.......#....##.......#..#....#.
.##......##....#....####.##..#.
.....#.##.....#...#....##......
.............#....#......#....#
#.#.#.###........#.#....#.#....
.##...........#................
#..#..#...##..##.##...#..#.#...
..#......##..#.#......#..#.#.#.
.....#..............#......#...
#.#..##.##...#............##...
.#......#.............#........
........##....#......#..#......
##.........##....#..........#..
..#..#....#.........##....#..#.
........#..#..#........#...#...
#.........#......##.#...#.##...
.##.............#..###....#.##.
.##.#....#.......#.............
#..##.#.........#..##.#......##
....#..#.......................
.#.#.........#...............#.
....#......#.#..##..#...#.#..#.
#....##...##..#.......##.....##
....##...##...#....#.....#..#..
.#......#.#.#.#......##..#..#..
.....##..#..#.....#.....#...##.
....###................#..#.#..
.....#..#..#.#..........#..#...
...#.....#............#........
#.............#...#..#.....#..#
#........#.....#.#..#......#...
...#.##.....#.#..#.........#..#
.......##...#..#.#....##.......
..................#..##..#.#.#.
..#......#..#..#.....#...#.#...
.#.......#.....#.#....#.#......
##..#.#....#.###..#...#.......#
.......................#.......
..###..........#..##.##.#...##.
.....#...#....###.........#..#.
..#.....#....###...............
....#.......#........#....#..#.
......#................#.#...##
#.....#.......#..#..........##.
#.#....##.........#.....#.#....
#.#.#...#............####.##..#
.....#....####........#...#..#.
....##........#.#..............
.#......#..#..##......#....#.##
..#....#.#........#..#....#....
.#...#.##...#.#.....#.....#...#
..........#................###.
.....#..........##..#..........
.....#..................#...#..
#......##....#.#...#..#.......#
..#......##....#......#.#...#..
###.#..###.#.#..#...#....#.....
#.....#.#...#.##...#........#..
#..........................#...
.#.#.....#.#.#.......##.#.#....
.#....#..##......#....#........
.#.......#.##......#.#..#......
............#.....#....##.##...
....##........##......#........
....#......##....##.....#......
..#.#.....#......#...#.#.......
.###.........#...#........#....
......#.#...##.....##..##..#...
...#...#.#......#..##..#.......
.##....#.#........#.#..........
#....#.#......#......#.#.#.....
#.....#.....#................##
...........#....#...#...#......
..........##..##..#...##.......
.##......#.......#..#.#..##....
..........##....#....#..#.#....
...............#......#.....##.
.#...#....................#..#.
.............###...............
.####..............#...#.......
....#...#.#...#...#....#.......
.......#.#.....................
...............................
#..#.........##.......#.#.#....
....##...#...........#......#..
........##...#......#..........
....#.#.....#..#......#........
#..#................#..#.##....
.#........#.......#.........##.
#...........#...#...#......#.#.
..#.#.#..........##.##...#...#.
..#...#.##...#.#...........#...
##...........##...##...##......
....#....##...#......#..#.....#
#..#.#.#..#...#...#....#.......
............#.....#....#....#.#
....##.....#.........#......#..
.....##.......#...#...#.###....
...##......##..###.#.#....#....
#.#.#.#..#.#.........#...#...##
..#..........#.................
....##....#....................
###.#...............##...##.#..
....#.......##.#..#.#..........
............##..#.......##.....
#...#.........#..#..#..#...#...
..#......##..#.#...##.#.......#
......#................#...#...
......#..###............#.#....
..#.#...###...#..#...#......##.
...#.##...##............#......
#...##........#.#..#.......#...
#..#.....#..#.##...............
..#.....#.#....#.........#.....
.............#....#..#...#.##..
..#.#.....................##.#.
........#.......#..#.#.........
##..............#.....#.......#
.#.##...###....#.....#..##.#...
#..#...#..#......#..........###
#...........#..#...#....#....#.
....#..#.......##......#......#
#...#.#...............##...#...
...##.#..##.......##..#........
...........##..........#.......
..#....#..##...#......#.#......
.#.#....#.#.#...#.#............
.#.#..#...##.......#.#.........
...#...#.............#.######..
##.#........###.......#....#.#.
.#....#.....#.#........#......#
..#.#.........#..........##.#..
.#....#.#..............#......#
.....#..##.........#..##..#....
........#..#....#.......#.....#
#.#.......#.....#.##.#...#....#
...#...##...#....#.....#....#.#
#..##....#..........#..#.......
.......#.#.....#...#.#.#.....##
#...#...#..#......##.#..#......
...#.......#....#...........#.#
##.......#####.#.........#..#..
....#.#...................##...
......#..##............#.......
#.........#....#####.#.#..#.#..
..#......#.#.##............#...
..#...#.....#.#....#......#....
.#...#....#....#.#.#......#.#..
..#.##.....#..........#...#.#..
.......#...#.............#...#.
.#.........#.....#.#........##.
#....#..#..........##.......##.
...#....#.#.........#.......###
......#....#.#......#.......#..
.....#...#...#.#...##..#.#.....
#.........##..#...##..#.#....#.
...#......#.#......##.....#....
.#####.....#.#.#.#...###.##....
..#................#.#...#.#...
#.......##...#.........##..#...
..#.....#....##............#...
#............##...............#
..#..#.................#.......
...............#..#.......##...
..##..#....#...##..........#..#
#...###....##.#.......#.....#..
..........#.........#..#......#
##....#.....#...##.......#.....
..#..#.......#.................
..#..##......#.........#......#
...........##.#..#......#.#..#.
..#...##...##......#...#...#.#.
.#..#.....#.........#..........
#..##...#............#..#.#....
..#...#...##.#........#....#.#.
......##..###.#....#........#..
.....#..#....##...##..........#
................#.#.#.....#..#.
#.##...#......#.#..#.......###.
.......#.#..#..#......#..##..#.
.##...#...#....#....#.......#..
......#..#....#.#.###.....#.#.#
#....#.#...#......#.#.....#..#.
.......#.#...#.#.#............#
#.....#..#...#.................
.....#..........#..#.#..#.#....
.........#......#.#.........###
..#.###........#....##.#.......
.#.......#.#......#........#..#
............#........#.....#...
......#......#....#.#....#.....
.#.......#.....#.##.#..#...#..#
##.....#...#..........##..#...#
.#........#....#...#....##.#...
...#.#.......#.#....#.#...#...#
........#.#.....#.##...#.#.#...
...........#....#..#.........#.
......#.#..#..##...#.......#...
...#....#..#..#.##...........##
.#..#.#.#......#....##...#.....
......#..#........#...##.......
.............#...##.#.....#...#
....#...............##......#.#
.#...........#.........###.##.#
....##........##...#.##.....#..
#......##........#...........#.
###.#.................#.....#..
.....##..#.........#......##.#.
#.#.......##.#..#...#...#......
...#.#..##.....#....##.....#.#.
...##..#...#........#.#..#..#..
...........#....#...#...##.....
##.......#...#.#.##...##..#.#..
#....#.#..##...................
.#...................#.#..#....
#.....#..........#..#...#...#..
...#..#............#.#.........
............#..##.....##......#
#....#.........#.#..#..........
...#.#................#....#.#.
..#..#...#...#.#.#...#.#.#.....
..#.......#.............##..#.#
#........#.#.###.#...#..#.###..
.......#......#..#.....####...#
..##....#..#...................
....##.#....#......#.#..#..#..#
#...........##...#.#.##..###...
##.##......#...........#....#..
.#....#....#..#..#...##...#....
...##.#.#......#...............
.....##.##...#...........#.....
....#...#.#.........##.#....#.#
#..#...........#......#........
..#..#.....#....#.##.......#..#
..#.......##.....##.......#...#
.#.##.#..#...............#....#
.........#...........#.........
..........##......#.#..........
..#........###....#..#...#...#.
....#.#...#.....#..#....#......
..##...##...#..#..##......##..#
..#..#......#....#....#...#..##
...#...............#..#........
....##..#...#......#........#..
###.....##.......#.............
.#.#.##........##..#...#.......
.....###............#..#..#....
.#....##.#...####........#.....
............#.#.....##....#.#..
....#..........#...#...........
........#.#...#..##...........#
#.......#..#.......###...#....#
#....#..#......#.....#...##.#..
..#.............#.#.###...##..#
.#.#....#...#.....#...#.......#
.##.#..#.........#..#......#...
#....#...#......#.....#.....#..
...........#....#.......##...#.
#.#..##....#....#.#.......#.#..
..............#.#..##.##.......
....#........#......#....#.#...
......#.....................#..
#..##...##.....#.........#.....
#.....#.....#....#...#.....#...
........###...........#...#....
............#.....#...##....#..
.......#.......#...#.#...##....
..#.#..#....#...#...#....#.....
..........#.#....#....###....#.
.##...#......###..#............
...#...#........#....#....##...
##.....#.##...#.#...........#.#
..........#.#....#...##.#...#..
..#....#.#...#...#....#.###....
......#.##..#..#.........#.###.
#.#.#.....#.....##.......#.....
...#..#..#....#.#....#....#....
##..#.#................#......#
.....#...#..#......#..####.....
.....##.....#....####......#...
..........##..###.#....#.....##
###...#.......#......##...#....
.......##...#...#..#.##.#....##
.....##.....##...##.....#..#..#
......#.#.....#...#....#...#...
..##........#...#..............
..#........#.##.........#...#..
#....#....#................#...');

CREATE TABLE lines (s STRING);
WITH RECURSIVE
    nn (ROWID, s, rest)
AS (
    SELECT
        0,
        (SELECT SUBSTR(input.value, 0, INSTR(input.value, char(10))) FROM input),
        (SELECT SUBSTR(input.value, INSTR(input.value, char(10)) + 1) FROM input)
    UNION ALL
    SELECT
        ROWID + 1,
        CASE INSTR(nn.rest, char(10))
            WHEN 0 THEN nn.rest
            ELSE SUBSTR(nn.rest, 0, INSTR(nn.rest, char(10)))
        END,
        CASE INSTR(nn.rest, char(10))
            WHEN 0 THEN ''
            ELSE SUBSTR(nn.rest, INSTR(nn.rest, char(10)) + 1)
        END
    FROM nn
    WHERE LENGTH(nn.rest) > 0
)
INSERT INTO lines (ROWID, s)
SELECT nn.ROWID, nn.s FROM nn;

CREATE TABLE answer (i INT);
INSERT INTO answer VALUES (1);

WITH RECURSIVE
    nn (x, y, accumulator)
AS (
    SELECT 1, 1, 0
    UNION ALL
    SELECT
        (nn.x + 1) % (SELECT LENGTH(s) FROM lines LIMIT 1) ,
        nn.y + 1,
        nn.accumulator + (
            SELECT SUBSTR(s, nn.x + 1, 1) = '#' FROM lines WHERE ROWID = nn.y
        )
    FROM nn
    WHERE y < (SELECT COUNT(1) FROM lines)
)
INSERT INTO answer
SELECT MAX(accumulator) * (SELECT MAX(i) FROM ANSWER) FROM nn;

WITH RECURSIVE
    nn (x, y, accumulator)
AS (
    SELECT 3, 1, 0
    UNION ALL
    SELECT
        (nn.x + 3) % (SELECT LENGTH(s) FROM lines LIMIT 1) ,
        nn.y + 1,
        nn.accumulator + (
            SELECT SUBSTR(s, nn.x + 1, 1) = '#' FROM lines WHERE ROWID = nn.y
        )
    FROM nn
    WHERE y < (SELECT COUNT(1) FROM lines)
)
INSERT INTO answer
SELECT MAX(accumulator) * (SELECT MAX(i) FROM ANSWER) FROM nn;

WITH RECURSIVE
    nn (x, y, accumulator)
AS (
    SELECT 5, 1, 0
    UNION ALL
    SELECT
        (nn.x + 5) % (SELECT LENGTH(s) FROM lines LIMIT 1) ,
        nn.y + 1,
        nn.accumulator + (
            SELECT SUBSTR(s, nn.x + 1, 1) = '#' FROM lines WHERE ROWID = nn.y
        )
    FROM nn
    WHERE y < (SELECT COUNT(1) FROM lines)
)
INSERT INTO answer
SELECT MAX(accumulator) * (SELECT MAX(i) FROM ANSWER) FROM nn;

WITH RECURSIVE
    nn (x, y, accumulator)
AS (
    SELECT 7, 1, 0
    UNION ALL
    SELECT
        (nn.x + 7) % (SELECT LENGTH(s) FROM lines LIMIT 1) ,
        nn.y + 1,
        nn.accumulator + (
            SELECT SUBSTR(s, nn.x + 1, 1) = '#' FROM lines WHERE ROWID = nn.y
        )
    FROM nn
    WHERE y < (SELECT COUNT(1) FROM lines)
)
INSERT INTO answer
SELECT MAX(accumulator) * (SELECT MAX(i) FROM ANSWER) FROM nn;

WITH RECURSIVE
    nn (x, y, accumulator)
AS (
    SELECT 1, 2, 0
    UNION ALL
    SELECT
        (nn.x + 1) % (SELECT LENGTH(s) FROM lines LIMIT 1) ,
        nn.y + 2,
        nn.accumulator + (
            SELECT SUBSTR(s, nn.x + 1, 1) = '#' FROM lines WHERE ROWID = nn.y
        )
    FROM nn
    WHERE y < (SELECT COUNT(1) FROM lines)
)
INSERT INTO answer
SELECT MAX(accumulator) * (SELECT MAX(i) FROM ANSWER) FROM nn;

SELECT MAX(i) FROM answer;
